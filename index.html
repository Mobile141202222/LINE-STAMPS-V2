<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>On Boarding Program - Reward Card</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Kanit', sans-serif; background-color: #f4f4f4; overscroll-behavior-y: none; }
        .wurth-red { color: #CC0000; }
        .bg-wurth-red { background-color: #CC0000; }
        .border-wurth-red { border-color: #CC0000; }
        
        /* Custom Stamp Animation */
        @keyframes stampPop {
            0% { transform: scale(0); opacity: 0; }
            50% { transform: scale(1.3); opacity: 1; }
            100% { transform: scale(1); opacity: 1; }
        }
        .stamp-animate {
            animation: stampPop 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
        }
        
        /* Background Pattern */
        .bg-pattern {
            background-color: #CC0000;
            background-image: radial-gradient(#990000 1px, transparent 1px);
            background-size: 20px 20px;
        }

        /* Hide scrollbar for clean UI */
        ::-webkit-scrollbar { display: none; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // ==========================================
        // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ URL ‡∏Ç‡∏≠‡∏á Google Apps Script ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà !!
        // ==========================================
        const GAS_URL = 'https://script.google.com/macros/s/AKfycbzrfdDPATU7Mgq1go7O8aTlNAqQHYV-MFuj7OoWugLL2azsoWs8qo69KpojBpkCH21q_Q/exec'; 
        const TOTAL_STAMPS = 16;
        const LIFF_ID = '2009175418-UODHvYrB';

        const App = () => {
            const [profile, setProfile] = React.useState(null);
            const [points, setPoints] = React.useState(0);
            const [loading, setLoading] = React.useState(true);
            const [pinInput, setPinInput] = React.useState('');
            const [message, setMessage] = React.useState({ show: false, text: '', type: '' });
            const [recentStampIndex, setRecentStampIndex] = React.useState(-1);

            React.useEffect(() => {
                initializeLiff();
            }, []);

            const initializeLiff = async () => {
                try {
                    await liff.init({ liffId: LIFF_ID });
                    if (liff.isLoggedIn()) {
                        const userProfile = await liff.getProfile();
                        setProfile(userProfile);
                        fetchUserData(userProfile);
                    } else {
                        liff.login();
                    }
                } catch (err) {
                    console.error('LIFF Init Error', err);
                    // Mock data for browser testing outside LINE
                    const mockProfile = { userId: 'mock123', displayName: 'Mock User', pictureUrl: 'https://ui-avatars.com/api/?name=User&background=CC0000&color=fff' };
                    setProfile(mockProfile);
                    setPoints(5); // Mock points
                    setLoading(false);
                    showMessage('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏£‡∏±‡∏ô‡πÉ‡∏ô‡πÇ‡∏´‡∏°‡∏î‡∏à‡∏≥‡∏•‡∏≠‡∏á (‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô LINE)', 'warning');
                }
            };

            const fetchUserData = async (user) => {
                if(GAS_URL === 'https://script.google.com/macros/s/AKfycbzrfdDPATU7Mgq1go7O8aTlNAqQHYV-MFuj7OoWugLL2azsoWs8qo69KpojBpkCH21q_Q/exec') {
                    setLoading(false);
                    showMessage('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà GAS URL ‡πÉ‡∏ô‡πÇ‡∏Ñ‡πâ‡∏î', 'error');
                    return;
                }
                try {
                    setLoading(true);
                    const response = await fetch(`${GAS_URL}?action=getUser&userId=${user.userId}&displayName=${encodeURIComponent(user.displayName)}`);
                    const data = await response.json();
                    if (data.status === 'success') {
                        setPoints(parseInt(data.points) || 0);
                    }
                } catch (error) {
                    console.error('Error fetching user:', error);
                    showMessage('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ', 'error');
                } finally {
                    setLoading(false);
                }
            };

            const handleClaimToken = async (tokenString) => {
                if (!tokenString) return;
                
                if(GAS_URL === 'https://script.google.com/macros/s/AKfycbzrfdDPATU7Mgq1go7O8aTlNAqQHYV-MFuj7OoWugLL2azsoWs8qo69KpojBpkCH21q_Q/exec') {
                    showMessage('‡∏à‡∏≥‡∏•‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏™‡πÅ‡∏Å‡∏ô/‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™: ' + tokenString, 'success');
                    animateNewStamp();
                    return;
                }

                try {
                    setLoading(true);
                    const response = await fetch(`${GAS_URL}?action=addPoint&userId=${profile.userId}&pin=${tokenString}`, {
                        method: 'GET', // Using GET for simpler CORS handling in App Script
                    });
                    const data = await response.json();
                    
                    if (data.status === 'success') {
                        animateNewStamp();
                        showMessage('‡∏™‡∏∞‡∏™‡∏°‡πÅ‡∏ï‡πâ‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', 'success');
                    } else {
                        showMessage(data.message || '‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', 'error');
                    }
                } catch (error) {
                    showMessage('‡∏£‡∏∞‡∏ö‡∏ö‡∏Ç‡∏±‡∏î‡∏Ç‡πâ‡∏≠‡∏á ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà', 'error');
                } finally {
                    setLoading(false);
                    setPinInput('');
                }
            };

            const animateNewStamp = () => {
                setPoints(prev => {
                    const newPoints = Math.min(prev + 1, TOTAL_STAMPS);
                    setRecentStampIndex(newPoints - 1);
                    return newPoints;
                });
            };

            const scanQRCode = () => {
                if (liff.scanCodeV2) {
                    liff.scanCodeV2().then((result) => {
                        if (result && result.value) {
                            handleClaimToken(result.value);
                        }
                    }).catch((err) => {
                        showMessage('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏™‡πÅ‡∏Å‡∏ô‡πÑ‡∏î‡πâ', 'error');
                    });
                } else {
                    showMessage('‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏™‡πÅ‡∏Å‡∏ô QR Code', 'warning');
                }
            };

            const showMessage = (text, type) => {
                setMessage({ show: true, text, type });
                setTimeout(() => setMessage({ show: false, text: '', type: '' }), 3000);
            };

            if (loading && !profile) {
                return (
                    <div className="flex flex-col items-center justify-center min-h-screen bg-pattern">
                        <div className="animate-spin rounded-full h-12 w-12 border-4 border-white border-t-transparent"></div>
                        <p className="text-white mt-4 font-semibold text-lg animate-pulse">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>
                    </div>
                );
            }

            return (
                <div className="min-h-screen pb-10 flex flex-col bg-gray-100">
                    {/* Header Section */}
                    <div className="bg-pattern pt-8 pb-16 px-4 rounded-b-[2.5rem] shadow-lg relative">
                        <div className="flex items-center justify-between">
                            <h1 className="text-white text-2xl font-bold tracking-wide">
                                ON BOARDING <br/><span className="text-gray-200 text-sm font-normal">PROGRAM</span>
                            </h1>
                            <div className="bg-white/20 p-2 rounded-xl backdrop-blur-sm">
                                <i className="fas fa-gem text-white text-xl"></i>
                            </div>
                        </div>
                        
                        <div className="absolute -bottom-12 left-0 right-0 px-6">
                            <div className="bg-white rounded-2xl shadow-xl p-4 flex items-center space-x-4 border-t-4 border-wurth-red">
                                <img 
                                    src={profile?.pictureUrl || 'https://via.placeholder.com/150'} 
                                    alt="Profile" 
                                    className="w-16 h-16 rounded-full border-2 border-gray-100 shadow-sm object-cover"
                                />
                                <div>
                                    <h2 className="text-gray-800 font-bold text-lg">{profile?.displayName || 'User'}</h2>
                                    <div className="flex items-center text-sm text-gray-500 mt-1">
                                        <div className="w-2 h-2 rounded-full bg-green-500 mr-2"></div>
                                        ‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏≠‡∏¢‡∏π‡πà
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* Progress Text */}
                    <div className="mt-20 px-6 text-center">
                        <h3 className="text-gray-600 font-medium">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏™‡∏∞‡∏™‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</h3>
                        <div className="text-4xl font-bold wurth-red mt-1">
                            {points} <span className="text-xl text-gray-400 font-normal">/ {TOTAL_STAMPS}</span>
                        </div>
                    </div>

                    {/* Stamps Card Grid */}
                    <div className="mx-4 mt-6 bg-white rounded-2xl shadow-md p-5 border border-gray-100">
                        <div className="grid grid-cols-4 gap-4">
                            {Array.from({ length: TOTAL_STAMPS }).map((_, i) => {
                                const isEarned = i < points;
                                const isRecent = i === recentStampIndex;
                                return (
                                    <div key={i} className="relative aspect-square flex items-center justify-center">
                                        {/* Background Circle */}
                                        <div className={`absolute inset-0 rounded-full border-2 transition-colors duration-300 ${isEarned ? 'border-wurth-red bg-red-50' : 'border-gray-200 bg-gray-50'}`}></div>
                                        
                                        {/* Stamp Icon */}
                                        {isEarned ? (
                                            <i className={`fas fa-star wurth-red text-2xl relative z-10 ${isRecent ? 'stamp-animate' : ''}`}></i>
                                        ) : (
                                            <span className="text-gray-300 font-semibold relative z-10">{i + 1}</span>
                                        )}
                                        
                                        {/* Gift icon for specific milestones (e.g. 8 and 16) */}
                                        {(!isEarned && (i === 7 || i === 15)) && (
                                            <i className="fas fa-gift text-gray-300 text-2xl absolute opacity-30 z-0"></i>
                                        )}
                                    </div>
                                );
                            })}
                        </div>
                        
                        {points >= TOTAL_STAMPS && (
                            <div className="mt-6 p-3 bg-green-100 text-green-700 text-center rounded-lg font-bold animate-bounce">
                                üéâ ‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏î‡πâ‡∏ß‡∏¢! ‡∏Ñ‡∏∏‡∏ì‡∏™‡∏∞‡∏™‡∏°‡πÅ‡∏ï‡πâ‡∏°‡∏Ñ‡∏£‡∏ö‡πÅ‡∏•‡πâ‡∏ß üéâ
                            </div>
                        )}
                    </div>

                    {/* Input Section */}
                    <div className="mt-6 px-4 space-y-4 mb-8">
                        {/* Option 1: QR Code Scanner */}
                        <button 
                            onClick={scanQRCode}
                            disabled={loading || points >= TOTAL_STAMPS}
                            className={`w-full py-4 rounded-xl text-white font-bold shadow-lg flex items-center justify-center space-x-2 transition-transform active:scale-95 ${points >= TOTAL_STAMPS ? 'bg-gray-400' : 'bg-wurth-red hover:bg-red-700'}`}
                        >
                            <i className="fas fa-qrcode text-xl"></i>
                            <span>‡∏™‡πÅ‡∏Å‡∏ô QR Code ‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πâ‡∏°</span>
                        </button>

                        <div className="relative flex py-2 items-center">
                            <div className="flex-grow border-t border-gray-300"></div>
                            <span className="flex-shrink-0 mx-4 text-gray-400 text-sm">‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏î‡πâ‡∏ß‡∏¢‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á</span>
                            <div className="flex-grow border-t border-gray-300"></div>
                        </div>

                        {/* Option 2: Manual Input */}
                        <div className="flex space-x-2">
                            <input 
                                type="text" 
                                value={pinInput}
                                onChange={(e) => setPinInput(e.target.value)}
                                placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏™‡∏∞‡∏™‡∏°‡πÅ‡∏ï‡πâ‡∏°..."
                                disabled={loading || points >= TOTAL_STAMPS}
                                className="flex-1 bg-white border border-gray-300 text-gray-900 text-sm rounded-xl focus:ring-wurth-red focus:border-wurth-red block p-3 shadow-sm"
                            />
                            <button 
                                onClick={() => handleClaimToken(pinInput)}
                                disabled={!pinInput || loading || points >= TOTAL_STAMPS}
                                className="bg-gray-800 hover:bg-black text-white px-6 rounded-xl font-bold shadow-sm disabled:bg-gray-400 active:scale-95 transition-transform"
                            >
                                ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô
                            </button>
                        </div>
                    </div>

                    {/* Toast Notification */}
                    {message.show && (
                        <div className="fixed top-5 left-1/2 transform -translate-x-1/2 z-50 w-[90%] max-w-sm">
                            <div className={`p-4 rounded-xl shadow-xl text-center text-white font-medium ${message.type === 'error' ? 'bg-red-600' : message.type === 'warning' ? 'bg-yellow-500' : 'bg-green-600'}`}>
                                {message.text}
                            </div>
                        </div>
                    )}

                    {/* Loading Overlay */}
                    {loading && profile && (
                        <div className="fixed inset-0 bg-black/20 backdrop-blur-sm z-40 flex items-center justify-center">
                            <div className="bg-white p-4 rounded-xl shadow-lg flex items-center space-x-3">
                                <div className="animate-spin rounded-full h-6 w-6 border-b-2 border-wurth-red"></div>
                                <span className="font-medium text-gray-700">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•...</span>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
